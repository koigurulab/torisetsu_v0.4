<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>恋愛トリセツ仙人（無料トリセツ）</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffe5f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: #ffffff;
      box-shadow: 0 0 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }

    /* 上部ピンクバー */
    .header {
      padding: 12px 16px;
      background: #ff6b8b;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
    }

    .main {
      flex: 1;
      padding: 12px;
      background: #ffe5f0;
      overflow-y: auto;
    }

    .card {
      background: #fff;
      border-radius: 24px;
      border: 1px solid #ffd4e3;
      padding: 18px 16px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      /* 巻物背景に差し替える場合はここを編集
      background-image: url("scroll-bg.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center top;
      */
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: #ff6b8b;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      margin-right: 10px;
      font-size: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }
    .meta-title {
      font-size: 14px;
      font-weight: 600;
    }
    .meta-sub {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .card-body {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ffe1ee;
      font-size: 14px;
      line-height: 1.8;
      color: #333;
      white-space: normal;
      word-break: break-word;
    }
    .card-footer {
      margin-top: 14px;
      font-size: 12px;
      color: #777;
    }

    /* 見出し系 */
    .main-headline {
      margin: 8px 0 8px;
      font-size: 19px;
      font-weight: 700;
      color: #ff4b8a;
      text-align: center;
    }

    /* キャッチコピー本文（星のかけら型…など） */
    .catchcopy-main {
      margin: 4px 0 16px;
      font-size: 16px;
      font-weight: 700;
      color: #333;
      text-align: center;
    }

    .sub-headline {
      margin-top: 18px;
      margin-bottom: 8px;
      font-weight: 700;
      color: #ff4b8a;
    }
    .paragraph-space {
      height: 0.6em;
    }
    .card-body p {
      margin: 0 0 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">恋愛トリセツ仙人（無料トリセツ）</div>
    <div class="main">
      <div class="card">
        <div class="card-header">
          <div class="avatar">仙</div>
          <div>
            <div class="meta-title">恋愛トリセツ仙人</div>
            <div class="meta-sub" id="nickname-line">いま仙人が執筆中じゃ…</div>
          </div>
        </div>
        <div id="report-body" class="card-body"></div>
        <div id="status" class="card-footer">
          トリセツを生成しておるから、しばし待つのじゃ…
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const bodyEl   = document.getElementById("report-body");
      const statusEl = document.getElementById("status");
      const nickEl   = document.getElementById("nickname-line");

      // インテークから保存しておいた回答を取得
      let raw = localStorage.getItem("freeReportAnswers");
      if (!raw) {
        statusEl.textContent = "インテークの回答が見つからん。最初の画面からやり直してくれい。";
        return;
      }

      let answers;
      try {
        answers = JSON.parse(raw);
      } catch (e) {
        console.error(e);
        statusEl.textContent = "データの読み込みに失敗したようじゃ…。";
        return;
      }

      const name = answers?.profile?.name || "お主";
      nickEl.textContent = `${name}のトリセツを執筆中じゃ…`;

      // HTML用エスケープ
      function escapeHtml(str) {
        return (str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      // LLMの素のテキストを、見出し・キャッチコピー付きのHTMLに変換
      function renderReport(text) {
        const normalized = (text || "").replace(/\r\n/g, "\n");
        const lines = normalized.split("\n");

        const htmlParts = [];
        let mainHeadlineDone = false;
        let expectCatchcopyMain = false; // 次の非空行をキャッチコピー本文として扱うかどうか

        for (let i = 0; i < lines.length; i++) {
          const rawLine = lines[i];
          const line = rawLine.trim();

          // 完全な空行は段落の隙間だけ作る
          if (!line) {
            htmlParts.push('<p class="paragraph-space"></p>');
            continue;
          }

          // 直前に「キャッチコピー見出し」があり、
          // まだ本文を拾っていない場合はこの行をキャッチコピー本文にする
          if (expectCatchcopyMain) {
            htmlParts.push(
              `<p class="catchcopy-main">${escapeHtml(line)}</p>`
            );
            expectCatchcopyMain = false;
            continue;
          }

          // ◆ で始まる行は見出し処理
          if (line.startsWith("◆")) {
            // 「◆〜〜」部分と、その後ろの本文を分離（スペース or 全角スペース）
            const m = line.match(/^(◆\s*[^\s　]+(?:の[^\s　]+)*)(?:[ \u3000]+(.*))?$/);
            let heading = line;
            let restText = "";

            if (m) {
              heading = m[1];
              restText = m[2] || "";
            }

            const escHeading = escapeHtml(heading);

            if (heading.includes("キャッチコピー")) {
              // メインのキャッチコピー見出し
              if (!mainHeadlineDone) {
                htmlParts.push(`<p class="main-headline">${escHeading}</p>`);
                mainHeadlineDone = true;
              } else {
                htmlParts.push(`<p class="sub-headline">${escHeading}</p>`);
              }

              // 同じ行の後ろにキャッチコピー本文がある場合
              if (restText) {
                htmlParts.push(
                  `<p class="catchcopy-main">${escapeHtml(restText)}</p>`
                );
                expectCatchcopyMain = false;
              } else {
                // 次の非空行をキャッチコピー本文として扱う
                expectCatchcopyMain = true;
              }
            } else {
              // 仕事モード・恋愛モードなどの小見出し
              htmlParts.push(`<p class="sub-headline">${escHeading}</p>`);
              if (restText) {
                htmlParts.push(`<p>${escapeHtml(restText)}</p>`);
              }
              expectCatchcopyMain = false;
            }
          } else {
            // 通常の本文段落
            htmlParts.push(`<p>${escapeHtml(line)}</p>`);
          }
        }

        bodyEl.innerHTML = htmlParts.join("\n");
      }

      // レポートを取得（ストリームで受信しつつ、途中はプレーンテキスト表示 → 完了後に整形）
      async function fetchReport() {
        try {
          const resp = await fetch("/api/free-report-stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(answers),
          });

          if (!resp.ok || !resp.body) {
            statusEl.textContent = "トリセツ生成中にエラーが起きたようじゃ…。";
            return;
          }

          const reader  = resp.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let fullText = "";
          let firstChunk = true;

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            let chunk = decoder.decode(value, { stream: true });

            // 最初のチャンクの頭に入っている余計な空白などを削る
            if (firstChunk) {
              chunk = chunk.replace(/^\s+/, "");
              firstChunk = false;
            }

            fullText += chunk;

            // 執筆中はプレーンテキストとしてだんだん表示
            bodyEl.textContent = fullText;
          }

          // すべて受信し終わったら、見出し付きのレイアウトに整形して表示
          renderReport(fullText);
          statusEl.textContent = "トリセツの生成が完了したぞ。じっくり読んでみるのじゃ。";
        } catch (e) {
          console.error(e);
          statusEl.textContent = "トリセツ生成中に何かトラブルが起きたようじゃ…。";
        }
      }

      fetchReport();
    });
  </script>
</body>
</html>
